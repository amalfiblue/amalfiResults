{% extends "base.html" %}

{% block title %}Admin Panel - Amalfi Results{% endblock %}

{% block extra_css %}
<style>
    .review-image {
        max-height: 800px;
        object-fit: contain;
    }
    .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    .loading-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block content %}
    <div id="loading" class="loading">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Processing request...</p>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">Admin Panel</h4>
                    </div>
                    <div class="card-body">
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="division" class="form-label">Select Division</label>
                                    <select class="form-select" id="division" name="division">
                                        <option value="">Select Division</option>
                                        <!-- Electorates will be loaded via JavaScript -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#resetResultsModal">
                                    Reset Results
                                </button>
                                <a href="/admin/tcp-candidates/{{ division|urlencode }}" class="btn btn-warning">
                                    Set TCP Candidates
                                </a>
                            </div>
                        </div>
                        
                        <!-- Unreviewed Results Section -->
                        <div id="unreviewed-results-section" class="mb-4">
                            <h5>Results Pending Review</h5>
                            <div id="unreviewed-results-alert" class="alert alert-warning d-none">
                                There are <span id="unreviewed-count">0</span> results waiting for review
                            </div>
                            <div id="no-unreviewed-results-alert" class="alert alert-success">
                                No results waiting for review
                            </div>
                            <div id="unreviewed-results-list" class="list-group">
                                <!-- Unreviewed results will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Polling Places Table -->
                        <h5>Polling Places in <span id="division-title">{{ division }}</span></h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Polling Place Name</th>
                                        <th>State</th>
                                        <th>2022 Liberal/National %</th>
                                        <th>2022 Labor %</th>
                                        <th>2022 Swing</th>
                                        <th>Current Results</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="polling-places-table">
                                    <!-- Polling places will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reset Results Modal -->
    <div class="modal fade" id="resetResultsModal" tabindex="-1" aria-labelledby="resetResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetResultsModalLabel">Reset Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="reset_option" id="resetDivision" value="division" checked>
                            <label class="form-check-label" for="resetDivision">
                                Reset all results for <span id="reset-division-name">{{ division }}</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="reset_option" id="resetAll" value="all">
                            <label class="form-check-label" for="resetAll">
                                Reset all results for all divisions
                            </label>
                        </div>
                    </div>
                    <div class="text-danger mb-3">
                        Warning: This action cannot be undone!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="resetResults()">Reset Results</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Review Result Modal -->
    <div class="modal fade" id="reviewResultModal" tabindex="-1" aria-labelledby="reviewResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewResultModalLabel">Review Tally Sheet Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4>Metadata</h4>
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <th>ID</th>
                                        <td id="result-id"></td>
                                    </tr>
                                    <tr>
                                        <th>Timestamp</th>
                                        <td id="result-timestamp"></td>
                                    </tr>
                                    <tr>
                                        <th>Electorate</th>
                                        <td id="result-electorate"></td>
                                    </tr>
                                    <tr>
                                        <th>Booth Name</th>
                                        <td id="result-booth-name"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Original Image Column -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Original Tally Sheet Image</h4>
                                </div>
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <a id="image-link" href="#" target="_blank" class="btn btn-outline-primary mb-3">
                                            Open Image in New Tab
                                        </a>
                                    </div>
                                    <img id="result-image" src="" alt="Tally Sheet" class="img-fluid border review-image">
                                </div>
                            </div>
                        </div>
                        
                        <!-- OCR Results Column -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Extracted Data</h4>
                                </div>
                                <div class="card-body">
                                    <!-- Primary Votes Section -->
                                    <h5>Primary Votes</h5>
                                    <div id="primary-votes-container">
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Candidate</th>
                                                        <th>Primary Votes</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="primary-votes-table">
                                                    <!-- Primary votes will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div id="no-primary-votes" class="alert alert-info mb-4 d-none">No primary vote data available.</div>
                                    
                                    <!-- TCP Votes Section -->
                                    <h5>Two-Candidate Preferred</h5>
                                    <div id="tcp-votes-container">
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered">
                                                <thead class="table-light" id="tcp-votes-header">
                                                    <tr>
                                                        <th>Candidate</th>
                                                        <!-- TCP candidates will be loaded here -->
                                                    </tr>
                                                </thead>
                                                <tbody id="tcp-votes-table">
                                                    <!-- TCP votes will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div id="no-tcp-votes" class="alert alert-info mb-4 d-none">No two-candidate preferred data available.</div>
                                    
                                    <!-- Vote Totals Section -->
                                    <h5>Vote Totals</h5>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Category</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Formal Votes</td>
                                                    <td id="formal-votes">Unknown</td>
                                                </tr>
                                                <tr>
                                                    <td>Informal Votes</td>
                                                    <td id="informal-votes">Unknown</td>
                                                </tr>
                                                <tr>
                                                    <td>Total Votes</td>
                                                    <td id="total-votes">Unknown</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="rejectResult()">Reject Result</button>
                    <button type="button" class="btn btn-success" onclick="approveResult()">Approve Result</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "/api";
        let currentResultId = null;
        let currentDivision = "{{ division }}";
        
        // Load electorates from FastAPI when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadElectorates();
            loadPollingPlaces(currentDivision);
            loadUnreviewedResults(currentDivision);
            
            // Set up division change handler
            document.getElementById('division').addEventListener('change', function() {
                currentDivision = this.value;
                loadPollingPlaces(currentDivision);
                loadUnreviewedResults(currentDivision);
            });
        });
        
        // Function to load electorates from FastAPI
        function loadElectorates() {
            fetch(`${API_URL}/electorates`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    updateElectoratesDropdown(data.electorates);
                } else {
                    console.error('Error loading electorates:', data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error loading electorates:', error);
            });
        }
        
        // Function to update the electorates dropdown
        function updateElectoratesDropdown(electorates) {
            const dropdown = document.getElementById('division');
            
            // Keep the first option
            const firstOption = dropdown.options[0];
            dropdown.innerHTML = '';
            dropdown.appendChild(firstOption);
            
            // Add electorates from API
            electorates.forEach(electorate => {
                const option = document.createElement('option');
                option.value = electorate;
                option.textContent = electorate;
                if (electorate === currentDivision) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });
        }
        
        // Show loading overlay
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Load polling places for a division
        async function loadPollingPlaces(division) {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/admin/polling-places/${division}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const pollingPlacesTable = document.getElementById('polling-places-table');
                    pollingPlacesTable.innerHTML = '';
                    
                    data.polling_places.forEach(place => {
                        const row = document.createElement('tr');
                        
                        // Format swing display
                        let swingDisplay = 'No swing';
                        if (place.swing > 0) {
                            swingDisplay = `<span class="text-danger">+${place.swing.toFixed(2)}% to ALP</span>`;
                        } else if (place.swing < 0) {
                            swingDisplay = `<span class="text-primary">${place.swing.toFixed(2)}% to LNP</span>`;
                        }
                        
                        row.innerHTML = `
                            <td>${place.polling_place_name}</td>
                            <td>${place.state}</td>
                            <td>${place.liberal_national_percentage.toFixed(2)}%</td>
                            <td>${place.labor_percentage.toFixed(2)}%</td>
                            <td>${swingDisplay}</td>
                            <td>
                                <span class="badge bg-secondary">No results</span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="resetBoothResults('${place.polling_place_name}')">
                                    Reset
                                </button>
                            </td>
                        `;
                        
                        pollingPlacesTable.appendChild(row);
                    });
                    
                    // Update division title
                    document.getElementById('division-title').textContent = division;
                    document.getElementById('reset-division-name').textContent = division;
                }
            } catch (error) {
                console.error('Error loading polling places:', error);
                alert('Error loading polling places. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Load unreviewed results for a division
        async function loadUnreviewedResults(division) {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/admin/unreviewed-results/division/${division}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const unreviewedResultsList = document.getElementById('unreviewed-results-list');
                    unreviewedResultsList.innerHTML = '';
                    
                    const unreviewedCount = data.unreviewed_results.length;
                    document.getElementById('unreviewed-count').textContent = unreviewedCount;
                    
                    if (unreviewedCount > 0) {
                        document.getElementById('unreviewed-results-alert').classList.remove('d-none');
                        document.getElementById('no-unreviewed-results-alert').classList.add('d-none');
                        
                        data.unreviewed_results.forEach(result => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.onclick = function() { openReviewModal(result.id); return false; };
                            
                            const timestamp = new Date(result.timestamp).toLocaleString();
                            
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${result.booth_name || 'Unknown Booth'}</h5>
                                    <small>${timestamp}</small>
                                </div>
                                <p class="mb-1">Electorate: ${result.electorate || 'Unknown'}</p>
                            `;
                            
                            unreviewedResultsList.appendChild(item);
                        });
                    } else {
                        document.getElementById('unreviewed-results-alert').classList.add('d-none');
                        document.getElementById('no-unreviewed-results-alert').classList.remove('d-none');
                    }
                }
            } catch (error) {
                console.error('Error loading unreviewed results:', error);
                alert('Error loading unreviewed results. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Open review modal for a result
        async function openReviewModal(resultId) {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/admin/result/${resultId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const result = data.result;
                    currentResultId = result.id;
                    
                    // Set metadata
                    document.getElementById('result-id').textContent = result.id;
                    document.getElementById('result-timestamp').textContent = new Date(result.timestamp).toLocaleString();
                    document.getElementById('result-electorate').textContent = result.electorate || 'Unknown';
                    document.getElementById('result-booth-name').textContent = result.booth_name || 'Unknown';
                    
                    // Set image
                    const imageUrl = result.image_url;
                    document.getElementById('result-image').src = imageUrl;
                    document.getElementById('image-link').href = imageUrl;
                    
                    // Set primary votes
                    const primaryVotes = result.data?.primary_votes || {};
                    const primaryVotesTable = document.getElementById('primary-votes-table');
                    primaryVotesTable.innerHTML = '';
                    
                    if (Object.keys(primaryVotes).length > 0) {
                        document.getElementById('primary-votes-container').classList.remove('d-none');
                        document.getElementById('no-primary-votes').classList.add('d-none');
                        
                        for (const [candidate, votes] of Object.entries(primaryVotes)) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${candidate}</td>
                                <td>${votes}</td>
                            `;
                            primaryVotesTable.appendChild(row);
                        }
                    } else {
                        document.getElementById('primary-votes-container').classList.add('d-none');
                        document.getElementById('no-primary-votes').classList.remove('d-none');
                    }
                    
                    // Set TCP votes
                    const tcpVotes = result.data?.two_candidate_preferred || {};
                    const tcpVotesHeader = document.getElementById('tcp-votes-header');
                    const tcpVotesTable = document.getElementById('tcp-votes-table');
                    tcpVotesHeader.innerHTML = '';
                    tcpVotesTable.innerHTML = '';
                    
                    if (Object.keys(tcpVotes).length > 0) {
                        document.getElementById('tcp-votes-container').classList.remove('d-none');
                        document.getElementById('no-tcp-votes').classList.add('d-none');
                        
                        // Create header row
                        const headerRow = document.createElement('tr');
                        headerRow.innerHTML = '<th>Candidate</th>';
                        
                        for (const tcpCandidate of Object.keys(tcpVotes)) {
                            headerRow.innerHTML += `<th>${tcpCandidate}</th>`;
                        }
                        
                        tcpVotesHeader.appendChild(headerRow);
                        
                        // Get all candidates
                        const allCandidates = new Set();
                        for (const votes of Object.values(tcpVotes)) {
                            for (const candidate of Object.keys(votes)) {
                                allCandidates.add(candidate);
                            }
                        }
                        
                        // Create rows for each candidate
                        for (const candidate of allCandidates) {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${candidate}</td>`;
                            
                            for (const tcpCandidate of Object.keys(tcpVotes)) {
                                const votes = tcpVotes[tcpCandidate][candidate] || '-';
                                row.innerHTML += `<td>${votes}</td>`;
                            }
                            
                            tcpVotesTable.appendChild(row);
                        }
                    } else {
                        document.getElementById('tcp-votes-container').classList.add('d-none');
                        document.getElementById('no-tcp-votes').classList.remove('d-none');
                    }
                    
                    // Set vote totals
                    const totals = result.data?.totals || {};
                    document.getElementById('formal-votes').textContent = totals.formal || 'Unknown';
                    document.getElementById('informal-votes').textContent = totals.informal || 'Unknown';
                    document.getElementById('total-votes').textContent = totals.total || 'Unknown';
                    
                    // Show modal
                    const reviewModal = new bootstrap.Modal(document.getElementById('reviewResultModal'));
                    reviewModal.show();
                }
            } catch (error) {
                console.error('Error loading result:', error);
                alert('Error loading result. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Reset results for a booth
        async function resetBoothResults(boothName) {
            if (confirm(`Are you sure you want to reset results for ${boothName}? This action cannot be undone!`)) {
                showLoading();
                try {
                    const response = await fetch(`${API_URL}/admin/reset-results`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            division: currentDivision,
                            booth_name: boothName
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        alert(data.message);
                        loadPollingPlaces(currentDivision);
                        loadUnreviewedResults(currentDivision);
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error resetting booth results:', error);
                    alert('Error resetting booth results. Please try again.');
                } finally {
                    hideLoading();
                }
            }
        }
        
        // Reset results
        async function resetResults() {
            const resetOption = document.querySelector('input[name="reset_option"]:checked').value;
            const allResults = resetOption === 'all';
            
            if (confirm(`Are you sure you want to reset ${allResults ? 'all results' : `results for ${currentDivision}`}? This action cannot be undone!`)) {
                showLoading();
                try {
                    const response = await fetch(`${API_URL}/admin/reset-results`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            division: currentDivision,
                            all_results: allResults
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        alert(data.message);
                        
                        // Close modal
                        const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetResultsModal'));
                        resetModal.hide();
                        
                        loadPollingPlaces(currentDivision);
                        loadUnreviewedResults(currentDivision);
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error resetting results:', error);
                    alert('Error resetting results. Please try again.');
                } finally {
                    hideLoading();
                }
            }
        }
        
        // Approve result
        async function approveResult() {
            if (confirm('Are you sure you want to approve this result?')) {
                showLoading();
                try {
                    const response = await fetch(`${API_URL}/admin/review-result/${currentResultId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'approve'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        alert(data.message);
                        
                        // Close modal
                        const reviewModal = bootstrap.Modal.getInstance(document.getElementById('reviewResultModal'));
                        reviewModal.hide();
                        
                        loadUnreviewedResults(currentDivision);
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error approving result:', error);
                    alert('Error approving result. Please try again.');
                } finally {
                    hideLoading();
                }
            }
        }
        
        // Reject result
        async function rejectResult() {
            if (confirm('Are you sure you want to reject this result?')) {
                showLoading();
                try {
                    const response = await fetch(`${API_URL}/admin/review-result/${currentResultId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'reject'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        alert(data.message);
                        
                        // Close modal
                        const reviewModal = bootstrap.Modal.getInstance(document.getElementById('reviewResultModal'));
                        reviewModal.hide();
                        
                        loadUnreviewedResults(currentDivision);
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error rejecting result:', error);
                    alert('Error rejecting result. Please try again.');
                } finally {
                    hideLoading();
                }
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set up division change handler
            document.getElementById('division').addEventListener('change', function() {
                currentDivision = this.value;
                loadPollingPlaces(currentDivision);
                loadUnreviewedResults(currentDivision);
            });
            
            // Load initial data
            loadPollingPlaces(currentDivision);
            loadUnreviewedResults(currentDivision);
        });
    </script>
{% endblock %}

{% block extra_js %}
<script>
    // JavaScript code is already included in the content block
</script>
{% endblock %}
